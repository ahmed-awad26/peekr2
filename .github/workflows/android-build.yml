name: Build APK (Smart Detect)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v5

      - name: Detect project root (settings.gradle)
        shell: bash
        run: |
          set -euo pipefail
          ROOT_DIR="$(dirname "$(find . -maxdepth 8 -type f \( -name settings.gradle -o -name settings.gradle.kts \) -print -quit)")"
          if [ -z "$ROOT_DIR" ]; then
            echo "❌ Could not find settings.gradle / settings.gradle.kts" >&2
            exit 1
          fi
          echo "PROJECT_ROOT=$ROOT_DIR" >> "$GITHUB_ENV"
          echo "✅ PROJECT_ROOT=$ROOT_DIR"

      - name: Find a Debug assemble task across modules
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"

          SETTINGS_FILE=""
          if [ -f settings.gradle ]; then SETTINGS_FILE="settings.gradle"; fi
          if [ -f settings.gradle.kts ]; then SETTINGS_FILE="settings.gradle.kts"; fi
          if [ -z "$SETTINGS_FILE" ]; then
            echo "❌ settings file not found in PROJECT_ROOT" >&2
            exit 1
          fi

          echo "Using $SETTINGS_FILE"

          # Extract includes like :app, :mobile:app from Groovy/KTS include(...) / include("...")
          MODULES=$(grep -Eo 'include\([^)]*\)' "$SETTINGS_FILE" \
            | sed -E 's/include\((.*)\)/\1/' \
            | tr ',' '\n' \
            | sed -E 's/["'\'']//g; s/[[:space:]]//g' \
            | grep -E '^:.*' || true)

          # Fallback: if parsing failed, try common module names
          if [ -z "$MODULES" ]; then
            MODULES=":app
:mobile
:androidApp"
          fi

          echo "Modules to probe:"
          echo "$MODULES" | sed 's/^/ - /'

          FOUND_TASK=""
          FOUND_MODULE=""
          while read -r M; do
            [ -z "$M" ] && continue
            echo "---- Probing $M ----"
            if ./gradlew "$M:tasks" --all --console=plain > /tmp/tasks.txt 2>/dev/null; then
              # Prefer assembleDebug, else any assemble*Debug (flavors)
              if grep -qE '^assembleDebug\b' /tmp/tasks.txt; then
                FOUND_TASK="$M:assembleDebug"
                FOUND_MODULE="$M"
                break
              fi
              CAND=$(grep -Eo '^assemble[A-Za-z0-9]*Debug\b' /tmp/tasks.txt | head -n 1 || true)
              if [ -n "$CAND" ]; then
                FOUND_TASK="$M:$CAND"
                FOUND_MODULE="$M"
                break
              fi
            else
              echo "Skipping $M (no tasks / not a gradle module)"
            fi
          done <<< "$MODULES"

          if [ -z "$FOUND_TASK" ]; then
            echo "❌ لم أجد أي assemble*Debug task في أي module." >&2
            echo "جرّبت modules من settings. راجع settings.gradle وتأكد في module تطبيق." >&2
            echo "Tip: شغّل محلياً: ./gradlew projects" >&2
            exit 1
          fi

          echo "✅ FOUND_MODULE=$FOUND_MODULE" | tee -a "$GITHUB_ENV"
          echo "✅ BUILD_TASK=$FOUND_TASK" | tee -a "$GITHUB_ENV"

      - name: Build Debug APK
        shell: bash
        run: |
          set -euo pipefail
          cd "$PROJECT_ROOT"
          echo "Building with: $BUILD_TASK"
          ./gradlew "$BUILD_TASK" --no-daemon --stacktrace

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: |
            **/build/outputs/apk/**/*.apk
          if-no-files-found: error
          retention-days: 7
